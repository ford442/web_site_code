const w=(i,t,e)=>i+(t-i)*e,d=(i,t,e,o)=>w(i,t,1-Math.exp(-e*o)),S=i=>i?.text?.match(/[A-G][#-]?\d/)?.[0],v=i=>{if(!i)return 0;const t=i.toUpperCase(),e={C:0,"C#":1,DB:1,D:2,"D#":3,EB:3,E:4,F:5,"F#":6,GB:6,G:7,"G#":8,AB:8,A:9,"A#":10,BB:10,B:11},o=t.match(/^([A-G](?:#|B)?)\-?(\d)$/);if(!o)return 0;const r=e[o[1]]??0,n=(parseInt(o[2],10)+1)*12+r;return 440*Math.pow(2,(n-69)/12)};class A{libopenmpt=null;currentModulePtr=0;audioContext=null;scriptNode=null;stereoPanner=null;gainNode=null;moduleInfo={title:"...",order:0,row:0,bpm:0,numChannels:0};patternMatrices={};channelStates=[];isPlaying=!1;isReady=!1;volume=1;visualState={beatPhase:0,kickTrigger:0,grooveAmount:0,activeChannels:0,channelData:[]};constructor(){this.init()}async init(){if(!window.libopenmptReady){console.error("libopenmptReady promise not found.");return}try{const t=await window.libopenmptReady;t&&typeof t.stringToUTF8=="function"?(this.libopenmpt=t,this.isReady=!0,console.log("AudioSystem initialized.")):console.error("libopenmpt library is not valid or complete.")}catch(t){console.error("AudioSystem init failed:",t)}}async loadModule(t){if(!this.isReady)return;const e=await t.arrayBuffer(),o=new Uint8Array(e);this.processModuleData(o,t.name)}processModuleData(t,e){if(!(!this.libopenmpt||!this.isReady)){this.stop(!1),this.currentModulePtr!==0&&(this.libopenmpt._openmpt_module_destroy(this.currentModulePtr),this.currentModulePtr=0);try{const o=this.libopenmpt,r=o._malloc(t.length);o.HEAPU8.set(t,r);const n=o._openmpt_module_create_from_memory2(r,t.length,0,0,0,0,0,0,0);if(o._free(r),n===0)throw new Error(`Failed to load module "${e}".`);this.currentModulePtr=n;const s=o.stringToUTF8("title"),a=o._openmpt_module_get_metadata(n,s),l=o.UTF8ToString(a)||e;o._free(s),o._openmpt_free_string(a),this.moduleInfo.title=l,this.preCachePatternData(n),this.play()}catch(o){console.error("Failed to load module:",o)}}}preCachePatternData(t){const e=this.libopenmpt;this.patternMatrices={};try{const o=e._openmpt_module_get_num_orders(t),r=e._openmpt_module_get_num_channels(t);this.moduleInfo.numChannels=r;for(let n=0;n<o;n++){const s=e._openmpt_module_get_order_pattern(t,n);if(s>=e._openmpt_module_get_num_patterns(t))continue;const a=e._openmpt_module_get_pattern_num_rows(t,s),l=[];for(let h=0;h<a;h++){const m=[];for(let p=0;p<r;p++){const c=e._openmpt_module_format_pattern_row_channel(t,s,h,p,0,1),_=e.UTF8ToString(c);e._openmpt_free_string(c);const f=(_||"").trim();m.push({text:f})}l.push(m)}this.patternMatrices[n]={rows:l,numRows:a,numChannels:r}}}catch(o){console.error("Pattern caching error:",o)}}play(){if(!(this.currentModulePtr===0||!this.libopenmpt)){if(!this.audioContext){const t=window.AudioContext||window.webkitAudioContext;this.audioContext=new t({sampleRate:44100})}if(this.audioContext.state==="suspended"&&this.audioContext.resume(),!this.isPlaying)try{this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=this.volume,this.gainNode.connect(this.audioContext.destination);const t=this.libopenmpt,e=this.currentModulePtr,o=t._malloc(4096*4),r=t._malloc(4096*4);this.scriptNode=this.audioContext.createScriptProcessor(4096,0,2),this.scriptNode.onaudioprocess=n=>{if(!this.isPlaying)return;const s=t._openmpt_module_read_float_stereo(e,44100,4096,o,r);if(s===0){t._openmpt_module_set_position_order_row(e,0,0);return}const a=n.outputBuffer.getChannelData(0),l=n.outputBuffer.getChannelData(1);a.set(new Float32Array(t.HEAPF32.buffer,o,s)),l.set(new Float32Array(t.HEAPF32.buffer,r,s))},this.stereoPanner=this.audioContext.createStereoPanner(),this.scriptNode.connect(this.stereoPanner),this.stereoPanner.connect(this.gainNode),this.isPlaying=!0,console.log("Playback started.")}catch(t){console.error("Playback failed:",t)}}}stop(t=!0){this.scriptNode&&(this.scriptNode.disconnect(),this.scriptNode=null),this.stereoPanner&&(this.stereoPanner.disconnect(),this.stereoPanner=null),this.isPlaying=!1,t&&this.currentModulePtr&&this.libopenmpt&&this.libopenmpt._openmpt_module_set_position_order_row(this.currentModulePtr,0,0)}update(){if(!this.libopenmpt||this.currentModulePtr===0||!this.isPlaying)return this.visualState.kickTrigger=d(this.visualState.kickTrigger,0,8,1/60),this.visualState;const t=this.libopenmpt,e=this.currentModulePtr,o=t._openmpt_module_get_current_order(e),r=t._openmpt_module_get_current_row(e),n=t._openmpt_module_get_current_estimated_bpm(e),s=t._openmpt_module_get_current_tempo2?.(e)??n,a=t._openmpt_module_get_current_speed?.(e)??6;this.visualState.beatPhase=(this.visualState.beatPhase+s/60*(1/60))%1,this.visualState.grooveAmount=d(this.visualState.grooveAmount,a%2===0?0:.1,3,1/60);const l=this.patternMatrices[o],h=l?.rows[r]||[],m=l?.numChannels||this.moduleInfo.numChannels;for(;this.visualState.channelData.length<m;)this.visualState.channelData.push({volume:0,trigger:0,note:"",freq:0});let p=!1;for(let c=0;c<m;c++){const _=t._openmpt_module_get_current_channel_vu_mono?.(e,c)??0,f=Math.min(1,_),y=h[c],g=S(y),P=g?1:0,b=v(g);P&&(p=!0);const u=this.visualState.channelData[c];u.volume=f,u.trigger=P?1:d(u.trigger,0,10,1/60),u.note=g||u.note,u.freq=b||u.freq}return p?this.visualState.kickTrigger=1:this.visualState.kickTrigger=d(this.visualState.kickTrigger,0,8,1/60),this.visualState}}export{A};
