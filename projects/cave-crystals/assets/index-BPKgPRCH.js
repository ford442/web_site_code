(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const h of r.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}})();const c=[{name:"Ruby",hex:"#FF0055",glow:"rgba(255, 0, 85, 0.6)"},{name:"Emerald",hex:"#00FF66",glow:"rgba(0, 255, 102, 0.6)"},{name:"Sapphire",hex:"#00CCFF",glow:"rgba(0, 204, 255, 0.6)"},{name:"Amethyst",hex:"#CC00FF",glow:"rgba(204, 0, 255, 0.6)"},{name:"Amber",hex:"#FFAA00",glow:"rgba(255, 170, 0, 0.6)"}],n={lanes:7,baseGrowthRate:.1,sporeExpandRate:8,penaltyGrowth:40,matchShrink:150},u={ctx:null,init:function(){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext)),this.ctx.state==="suspended"&&this.ctx.resume()},playTone:function(o,t,e,s=.1){if(!this.ctx)return;const i=this.ctx.createOscillator(),r=this.ctx.createGain();i.type=t,i.frequency.setValueAtTime(o,this.ctx.currentTime),r.gain.setValueAtTime(s,this.ctx.currentTime),r.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+e),i.connect(r),r.connect(this.ctx.destination),i.start(),i.stop(this.ctx.currentTime+e)},shoot:function(){if(!this.ctx)return;const o=this.ctx.createOscillator(),t=this.ctx.createGain();o.connect(t),t.connect(this.ctx.destination),o.type="sine",o.frequency.setValueAtTime(800,this.ctx.currentTime),o.frequency.exponentialRampToValueAtTime(100,this.ctx.currentTime+.2),t.gain.setValueAtTime(.1,this.ctx.currentTime),t.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.2),o.start(),o.stop(this.ctx.currentTime+.2)},match:function(){if(!this.ctx)return;const o=400+Math.random()*200;[o,o*1.25,o*1.5].forEach((t,e)=>{setTimeout(()=>{this.playTone(t,"sine",.6,.1)},e*50)})},mismatch:function(){if(!this.ctx)return;const o=this.ctx.createOscillator(),t=this.ctx.createGain();o.connect(t),t.connect(this.ctx.destination),o.type="sawtooth",o.frequency.setValueAtTime(150,this.ctx.currentTime),o.frequency.linearRampToValueAtTime(50,this.ctx.currentTime+.3),t.gain.setValueAtTime(.1,this.ctx.currentTime),t.gain.linearRampToValueAtTime(.01,this.ctx.currentTime+.3),o.start(),o.stop(this.ctx.currentTime+.3)},gameOver:function(){if(!this.ctx)return;const o=this.ctx.createOscillator(),t=this.ctx.createGain();o.connect(t),t.connect(this.ctx.destination),o.type="triangle",o.frequency.setValueAtTime(300,this.ctx.currentTime),o.frequency.exponentialRampToValueAtTime(10,this.ctx.currentTime+2),t.gain.setValueAtTime(.3,this.ctx.currentTime),t.gain.linearRampToValueAtTime(.01,this.ctx.currentTime+2),o.start(),o.stop(this.ctx.currentTime+2)}};class v{constructor(t,e,s,i){this.lane=t,this.type=e,this.height=s,this.colorIdx=i,this.flash=0,this.shapeSeed=Math.random()}update(t){this.height+=t,this.flash>0&&(this.flash-=.1)}}class T{constructor(t,e,s,i){this.x=t,this.y=e,this.lane=s,this.radius=10,this.colorIdx=i,this.active=!0}update(t,e,s,i){if(!this.active)return;this.radius+=n.sporeExpandRate;const r=t.find(l=>l.lane===this.lane&&l.type==="top"),h=t.find(l=>l.lane===this.lane&&l.type==="bottom");if(!r||!h)return;const p=this.y-this.radius<r.height,w=this.y+this.radius>e-h.height;let f=!1;p&&(f=!0,this.colorIdx===r.colorIdx?(u.match(),r.height=Math.max(10,r.height-n.matchShrink),r.flash=1,s(this.x,r.height,c[this.colorIdx].hex,20),i(10),r.colorIdx=Math.floor(Math.random()*c.length)):(u.mismatch(),r.height+=n.penaltyGrowth,s(this.x,r.height,"#555",5))),w&&(f=!0,this.colorIdx===h.colorIdx?(u.match(),h.height=Math.max(10,h.height-n.matchShrink),h.flash=1,s(this.x,e-h.height,c[this.colorIdx].hex,20),i(10),h.colorIdx=Math.floor(Math.random()*c.length)):(u.mismatch(),h.height+=n.penaltyGrowth,s(this.x,e-h.height,"#555",5))),f&&(this.active=!1)}}class S{constructor(t,e,s){this.x=t,this.y=e,this.vx=(Math.random()-.5)*10,this.vy=(Math.random()-.5)*10,this.life=1,this.color=s,this.size=Math.random()*4+1}update(){this.x+=this.vx,this.y+=this.vy,this.life-=.02}}class b{constructor(t){this.canvas=t,this.ctx=t.getContext("2d"),this.width=t.width,this.height=t.height,this.laneWidth=this.width/n.lanes}resize(t,e){this.width=t,this.height=e,this.canvas.width=t,this.canvas.height=e,this.laneWidth=t/n.lanes}clear(){this.ctx.clearRect(0,0,this.width,this.height)}draw(t){this.ctx&&(this.clear(),this.drawGuides(),t.crystals.forEach(e=>this.drawComplexCrystal(e)),this.drawCursor(t),t.spores.forEach(e=>this.drawSpore(e)),t.particles.forEach(e=>this.drawParticle(e)))}drawGuides(){this.ctx.strokeStyle="rgba(255, 255, 255, 0.05)",this.ctx.lineWidth=1;for(let t=1;t<n.lanes;t++){const e=t*this.laneWidth;this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.height),this.ctx.stroke()}}drawCursor(t){if(!t.active)return;const e=t.mouseLane*this.laneWidth+this.laneWidth/2;this.ctx.beginPath(),this.ctx.setLineDash([5,15]),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.height),this.ctx.strokeStyle="rgba(255, 255, 255, 0.1)",this.ctx.stroke(),this.ctx.setLineDash([]),this.ctx.beginPath(),this.ctx.arc(e,this.height/2,8,0,Math.PI*2),this.ctx.fillStyle="#fff",this.ctx.fill()}drawSpore(t){const e=c[t.colorIdx];this.ctx.shadowBlur=30,this.ctx.shadowColor=e.hex;const s=this.ctx.createRadialGradient(t.x,t.y,0,t.x,t.y,t.radius);s.addColorStop(0,"#fff"),s.addColorStop(.3,e.hex),s.addColorStop(1,"transparent"),this.ctx.fillStyle=s,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.radius,0,Math.PI*2),this.ctx.fill(),this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.radius*.4,0,Math.PI*2),this.ctx.fillStyle="#fff",this.ctx.fill(),this.ctx.shadowBlur=0}drawParticle(t){this.ctx.globalAlpha=t.life,this.ctx.shadowBlur=10*t.life,this.ctx.shadowColor=t.color,this.ctx.fillStyle=t.color,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,t.size,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowBlur=0,this.ctx.globalAlpha=1}drawComplexCrystal(t){const e=t.lane*this.laneWidth+this.laneWidth/2,s=this.laneWidth*.8,i=c[t.colorIdx],r=t.shapeSeed;t.flash>0?(this.ctx.shadowBlur=30*t.flash,this.ctx.shadowColor="white",this.ctx.fillStyle="#fff",this.ctx.strokeStyle="#fff"):(this.ctx.shadowBlur=25,this.ctx.shadowColor=i.glow,this.ctx.strokeStyle="rgba(255,255,255,0.6)"),this.ctx.lineWidth=1.5,this.ctx.lineJoin="round";const h=(p,w,f,l)=>{const y=t.height*w,m=s*f/2,d=t.type==="top"?0:this.height,g=t.type==="top"?y:this.height-y,a=e+p,x=this.ctx.createLinearGradient(a,d,a,g);t.flash>0?(x.addColorStop(0,"#fff"),x.addColorStop(1,"#fff")):(x.addColorStop(0,i.hex),x.addColorStop(1,"rgba(0,0,0,0.1)")),this.ctx.fillStyle=x,this.ctx.beginPath(),t.type==="top"?(this.ctx.moveTo(a-m,d),this.ctx.lineTo(a+l,g),this.ctx.lineTo(a+m,d)):(this.ctx.moveTo(a-m,d),this.ctx.lineTo(a+l,g),this.ctx.lineTo(a+m,d)),this.ctx.fill(),this.ctx.stroke(),t.flash<.5&&(this.ctx.fillStyle="rgba(255,255,255,0.2)",this.ctx.beginPath(),this.ctx.moveTo(a-m*.5,d),t.type==="top"?this.ctx.lineTo(a+l*.5,g*.8):this.ctx.lineTo(a+l*.5,this.height-(this.height-g)*.8),this.ctx.lineTo(a+m*.5,d),this.ctx.fill())};r>.3&&h(-s*.35,.6,.4,-5),r<.7&&h(s*.35,.5,.4,5),h(0,1,.6,0),this.ctx.shadowBlur=0}}class I{constructor(){this.canvas=document.createElement("canvas"),this.canvas.id="bgCanvas",this.gl=this.canvas.getContext("webgl");const t=document.getElementById("gameContainer");if(t.insertBefore(this.canvas,t.firstChild),this.resize(),window.addEventListener("resize",()=>this.resize()),!this.gl){console.warn("WebGL not supported for background");return}this.initShaders(),this.initBuffers(),this.startTime=Date.now(),requestAnimationFrame(this.render.bind(this))}resize(){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height)}initShaders(){const t=`
            attribute vec4 aVertexPosition;
            void main() {
                gl_Position = aVertexPosition;
            }
        `,e=`
            precision mediump float;
            uniform vec2 uResolution;
            uniform float uTime;

            // Simple noise function
            float noise(vec2 st) {
                return fract(sin(dot(st.xy, vec2(12.9898,78.233))) * 43758.5453123);
            }

            void main() {
                vec2 st = gl_FragCoord.xy / uResolution.xy;
                st.x *= uResolution.x / uResolution.y;

                vec3 color = vec3(0.0);

                // Deep cave background gradient
                vec3 topColor = vec3(0.05, 0.0, 0.1);
                vec3 botColor = vec3(0.0, 0.05, 0.15);
                color = mix(botColor, topColor, st.y);

                // Subtle moving mist/fog
                float t = uTime * 0.1;
                float mist = noise(st * 3.0 + t) * 0.1;
                color += vec3(mist * 0.2, mist * 0.1, mist * 0.3);

                // Distant faint crystals
                float stars = noise(st * 20.0);
                if (stars > 0.985) {
                    float twinkle = sin(uTime * 5.0 + stars * 100.0) * 0.5 + 0.5;
                    color += vec3(twinkle * 0.5);
                }

                gl_FragColor = vec4(color, 1.0);
            }
        `,s=this.loadShader(this.gl.VERTEX_SHADER,t),i=this.loadShader(this.gl.FRAGMENT_SHADER,e);this.program=this.gl.createProgram(),this.gl.attachShader(this.program,s),this.gl.attachShader(this.program,i),this.gl.linkProgram(this.program),this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)||console.error("Unable to initialize the shader program: "+this.gl.getProgramInfoLog(this.program)),this.programInfo={program:this.program,attribLocations:{vertexPosition:this.gl.getAttribLocation(this.program,"aVertexPosition")},uniformLocations:{resolution:this.gl.getUniformLocation(this.program,"uResolution"),time:this.gl.getUniformLocation(this.program,"uTime")}}}loadShader(t,e){const s=this.gl.createShader(t);return this.gl.shaderSource(s,e),this.gl.compileShader(s),this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)?s:(console.error("An error occurred compiling the shaders: "+this.gl.getShaderInfoLog(s)),this.gl.deleteShader(s),null)}initBuffers(){this.positionBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer);const t=[-1,1,1,1,-1,-1,1,-1];this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(t),this.gl.STATIC_DRAW)}render(){if(!this.gl)return;const t=(Date.now()-this.startTime)*.001;this.gl.clearColor(0,0,0,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.useProgram(this.programInfo.program),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.positionBuffer),this.gl.vertexAttribPointer(this.programInfo.attribLocations.vertexPosition,2,this.gl.FLOAT,!1,0,0),this.gl.enableVertexAttribArray(this.programInfo.attribLocations.vertexPosition),this.gl.uniform2f(this.programInfo.uniformLocations.resolution,this.canvas.width,this.canvas.height),this.gl.uniform1f(this.programInfo.uniformLocations.time,t),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),requestAnimationFrame(this.render.bind(this))}}class A{constructor(){this.background=new I,this.canvas=document.getElementById("gameCanvas"),this.renderer=new b(this.canvas),this.ui={start:document.getElementById("startScreen"),gameOver:document.getElementById("gameOverScreen"),score:document.getElementById("scoreVal"),finalScore:document.getElementById("finalScore"),level:document.getElementById("levelVal"),preview:document.getElementById("nextSporePreview"),startBtn:document.getElementById("startBtn"),restartBtn:document.getElementById("restartBtn")},this.state={active:!1,score:0,level:1,lastTime:0,crystals:[],spores:[],particles:[],nextSporeColorIdx:0,mouseLane:3,growthMultiplier:1},this.bindEvents(),this.resize(),requestAnimationFrame(this.loop.bind(this))}bindEvents(){this.ui.startBtn.addEventListener("click",()=>this.startGame()),this.ui.restartBtn.addEventListener("click",()=>this.resetGame()),window.addEventListener("resize",()=>this.resize()),window.addEventListener("mousemove",t=>this.handleMouseMove(t)),window.addEventListener("mousedown",t=>this.handleInput(t)),window.addEventListener("touchstart",t=>this.handleTouch(t))}resize(){this.renderer.resize(window.innerWidth,window.innerHeight)}startGame(){u.init(),this.state.active=!0,this.state.score=0,this.state.level=1,this.state.growthMultiplier=1,this.state.crystals=[],this.state.spores=[],this.state.particles=[],this.state.nextSporeColorIdx=Math.floor(Math.random()*c.length),this.ui.start.classList.add("hidden"),this.ui.gameOver.classList.add("hidden"),this.updateUI(),this.initCrystals()}resetGame(){this.startGame()}initCrystals(){for(let t=0;t<n.lanes;t++)this.state.crystals.push(new v(t,"top",20+Math.random()*60,Math.floor(Math.random()*c.length))),this.state.crystals.push(new v(t,"bottom",20+Math.random()*60,Math.floor(Math.random()*c.length)))}handleMouseMove(t){if(!this.state.active)return;const e=Math.floor(t.clientX/this.renderer.laneWidth);this.state.mouseLane=Math.min(Math.max(0,e),n.lanes-1)}handleInput(t){this.state.active&&this.shootSpore()}handleTouch(t){if(!this.state.active)return;const e=t.touches[0].clientX,s=Math.floor(e/this.renderer.laneWidth);this.state.mouseLane=Math.min(Math.max(0,s),n.lanes-1),this.shootSpore()}shootSpore(){u.shoot();const t=this.state.nextSporeColorIdx,e=this.state.mouseLane*this.renderer.laneWidth+this.renderer.laneWidth/2,s=this.renderer.height/2;this.state.spores.push(new T(e,s,this.state.mouseLane,t)),this.state.nextSporeColorIdx=Math.floor(Math.random()*c.length),this.updateUI()}createParticles(t,e,s,i=10){for(let r=0;r<i;r++)this.state.particles.push(new S(t,e,s))}update(t){this.state.growthMultiplier=1+this.state.score/500;const e=n.baseGrowthRate*this.state.growthMultiplier;let s=!1;if(this.state.crystals.forEach(i=>{i.update(e);const r=this.state.crystals.find(h=>h.lane===i.lane&&h.type!==i.type);r&&i.height+r.height>=this.renderer.height&&(s=!0)}),s){this.state.active=!1,u.gameOver(),this.ui.finalScore.innerText=this.state.score,this.ui.gameOver.classList.remove("hidden");return}for(let i=this.state.spores.length-1;i>=0;i--){let r=this.state.spores[i];r.update(this.state.crystals,this.renderer.height,this.createParticles.bind(this),h=>{this.state.score+=h}),r.active||(this.state.spores.splice(i,1),this.updateUI())}for(let i=this.state.particles.length-1;i>=0;i--){let r=this.state.particles[i];r.update(),r.life<=0&&this.state.particles.splice(i,1)}}updateUI(){this.ui.score.innerText=this.state.score,this.ui.level.innerText=Math.floor(this.state.score/500)+1;const t=c[this.state.nextSporeColorIdx];this.ui.preview.style.backgroundColor=t.hex,this.ui.preview.style.boxShadow=`0 0 20px ${t.hex}`}loop(t){this.state.lastTime||(this.state.lastTime=t);const e=t-this.state.lastTime;this.state.active&&this.update(e),this.renderer.draw(this.state),this.state.lastTime=t,requestAnimationFrame(this.loop.bind(this))}}window.addEventListener("DOMContentLoaded",()=>{new A});
